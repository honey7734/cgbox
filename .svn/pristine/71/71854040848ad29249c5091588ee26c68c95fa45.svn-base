<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
  "http://ibatis.apache.org/dtd/sql-map-2.dtd">
  
  <sqlMap namespace = "cart">
 
  <!-- cartView.jsp에 장바구니상품테이블에 있는 것을 가져오는 쿼리 -->
  <select id = "allcart" parameterClass = "int"> <!--  -->
  select * from cart_prod where cart_no = 
        (select cart_no from cart where customer_no = #data#)
  </select>
  
  
  <!-- 상품장바구니나 바로구매버튼 누르면 cart테이블에 자동으로 cart_no가 insert하는 쿼리 //단,장바구니번호가 생성되지 않은 고객이어야한다 -->
  
  <insert id = "insertcartno" parameterClass = "int">
   insert into cart (cart_no,customer_no,cart_sum) values( 
   (select nvl(max(cart_no)+1,1) from cart where customer_no = #customer_no#),
    #customer_no# ,0 )
   <!-- selectkey로 반환값이 장바구니 번호를 반환한다 -->
    <selectKey keyProperty= "customer_no">
      select cart_no from cart where customer_no = #customer_no#
    </selectKey>
  </insert>
  
  <!--cart_prod테이블에 소비자가 선택한 상품이 insert되는 쿼리
    "insertcartno"에서 반환받은 장바구니 번호를 파라미터로 이용할 것!
  -->
  <insert id ="insertprod" parameterClass = "cartVO" >
	insert into cart_prod (cart_no,prod_no,customer_no,cart_count,cart_status) 
	                   values(#cart_no#,#prod_no#,#customer_no#,#cart_count#,'N')  
  </insert>
  
 
  <!-- 1)소비자가 출력된 cart_prod테이블 정보에서 체크박스를 체크하고 결제하기 버튼을 누르면 cart_status가 y로 바뀐다
       2)바로구매하기 버튼을 누르면 'Y'로 바뀐다
  -->
  <update id = "updatestatus" parameterClass = "int">
	update cart_prod set cart_status = 'Y' where prod_no = #prodno#  
  </update>
  

  <!--cart테이블에 cart_sum 을 구해서 UPDATE하는 쿼리 ==>기본값은 0으로 설정  
    ==> PAY_STATUS가 'Y'되면 cart_sum은 다시 0이 된다 (트리거)
    ==> PAY_STATUS가 'Y'되면 CART_PROD에서 해당 레코드들은 삭제된다 (트리거)
  -->
  <update id = "cartsum" parameterClass = "int">
  
  UPDATE CART SET CART_SUM = 
        (SELECT SUM(A.CART_COUNT*B.PROD_PRICE) AS SUM
        FROM (SELECT * FROM CART_PROD WHERE CUSTOMER_NO = #customerno# AND CART_STATUS ='Y') A ,
        PROD B
        WHERE A.PROD_NO = B.PROD_NO)
        
  </update> 
  
  <!-- CART_PROD에서 소비자가 체크한 것을 삭제하는 쿼리 -->
  <delete id = "selectdelete"  parameterClass = "cartVO">
  delete from cart_prod where prod_no = #prod_no# and cart_no= #cart_no# 
  </delete>
  
  
  
  
  
  
  
  
 
  
  
  
  
  
  
  
  
  
  
  
  
  </sqlMap>